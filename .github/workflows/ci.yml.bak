name: â˜ƒ build-and-test
on:
  push:
    paths-ignore:
      - '*.md'
  workflow_dispatch:

env:
  REPO_NAME: te-cdn-packages

defaults:
  run:
    shell: bash

jobs:
  configure:
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.extract-branch.outputs.branch }}
    steps:
      - id: conf
        uses: mazoea/ga-maz/base-conf@master

  build-and-deploy:
    needs: configure
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        include:
          - GCCVERSION: 7
            IMAGE_TAG: u18g7
          - GCCVERSION: 8
            IMAGE_TAG: u18g8
    env:
      BUILDER: ci-at-${{ needs.configure.outputs.branch }}
      VERSION: ${{ github.run_id }}
      GCCVERSION: ${{ matrix.GCCVERSION }}
      CPU_NATIVE: false
      SLACK: ${{ secrets.SLACK_WEBHOOK_URL }}
      COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      TE_LIBS: /opt/mazoea/installation

    steps:
      - uses: mazoea/ga-maz/start@master
        with:
          MS_TEAMS_URI: ${{ secrets.MS_DQ_TEAMS_WEBHOOK_URI }}

      - uses: actions/checkout@v3

      - name: build
        working-directory: scripts
        run: |
          ./os.specific.sh
          ./build.sh
